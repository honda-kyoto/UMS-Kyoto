***************************************
KUHP Gmailアカウント一括操作 マニュアル
作成日：2013/12/25
改訂日：2014/01/27
作成者：dantec inoue
***************************************


●使い方(アカウント作成以外)
1. セレクトボックスから行いたい処理を選択する

2. テキストエリア内にユーザーのアカウントを記入する
   ※1行に1ユーザーアカウントを記入し、次のユーザーは改行後に記入する
   ※ユーザーアカウントはメールアドレスの@より前の部分のみを入力する
   ※空白行はスキップされます
   例)
      account_name01
      account_name02
          ~ 略 ~
      account_nameXX

3. 処理開始ボタンをクリックする

4. 処理完了までしばらく待つ(100件の処理で約2分程度時間を要する)

5. 処理終了の画面が表示されれば全件正常に処理終了
   ※エラーが発生した場合は、エラーメッセージが表示される
   ※エラーログを閲覧したい場合はエラーメッセージ内のリンクをクリックする


●使い方(アカウント作成)
Gmail登録、Gmailパスワード変更要求、Web領域登録、ML登録を一括で行います。
※アカウントの登録は1件あたり約30秒程度かかります
 アカウント登録中は処理中のブラウザで操作を行わないでください(別タブや別ウィンドウのブラウザを操作するのは問題ありません)


1. セレクトボックスから「アカウント作成」を選択する

2. Webサーバー、MLサーバーのログインパスワードを入力する

3. テキストエリア内に新規作成するユーザーの情報を記入する
   ※1行に1ユーザーアカウントを記入し、次のユーザーは改行後に記入する
   ※ユーザーアカウントはメールアドレスの@より前の部分のみを入力する
   ※空白行はスキップされます
   ※「1行目をヘッダ行として扱い...」にチェックが入っている場合、2行目から作成処理が行われます。
   ※「ユーザー情報のCSV区切り文字を、カンマではなく...」にチェックが入っている場合、ユーザー情報の区切り文字がカンマでなく、タブに変わります。
   ※CSVは以下の形式で記入してください
      アカウント名,職員番号,ﾌﾙﾈｰﾑ(漢字),姓(ローマ字),名(ローマ字),ﾌﾙﾈｰﾑ(ｶﾀｶﾅ),所属部署(漢字),所属部署(ローマ字),連絡先電話番号,職種,役職(備考)
   ※職種がgの時、MLサーバーへの登録処理はスキップされます（Gmail登録、Gmailパスワード変更要求、Web領域登録だけが行われる。）

4. 処理開始ボタンをクリックする

5. 処理完了までしばらく待つ(1件あたり約25秒程度時間を要する)
   ※処理終了まで時間がかかります
    その間ブラウザを閉じたり、画面遷移が行われる操作を行わないでください

6. 処理終了後、ログファイルへのリンクが表示されるのでログを確認する
   ※ログファイルに記載されている情報は以下の通りです
      ・処理日時
      ・処理者IP
      ・処理件数
      ・アカウント作成・登録ステータス一覧
      ・エラー・警告ログ一覧
      ・ログインパスワード一覧
   ※アカウント作成時に発生したエラーは全てログファイルに保存され、Webページには表示されません
   ※パスワードはログファイルに記載されています
   ※ログファイルは生成されてから30日経過すれば自動的に削除されます


●ファイル構成
gmail ┬ log ・・・ ログファイルの格納先
      │  ├ error ・・・エラーログファイルの格納先
      │  │  ├ error-log_yyyymmdd.txt
      │  │  ├   ~
      │  │  └ error-log_yyyymmdd.txt
      │  │
      │  ├ create ・・・新規アカウント作成ログファイルの格納先
      │  │   ├ create-log_yyyymmdd.txt
      │  │   ├   ~
      │  │   └ create-log_yyyymmdd.txt
      │  │
      │  └ .htaccess ・・・ ログディレクトリのみブラウザからディレクトリ表示可能なように設定
      │  
      ├ css  ・・・ CSSファイルの格納先
      │  └ default.css ・・・gmail/include/index.htmlが読み込む
      │
      ├ include  ・・・ html(view)ファイルの格納先
      │  └ index.html ・・Gmailアカウント一括操作のビュー
      │
      ├ image  ・・・ 画像ファイルの格納先(空)
      │
      ├ conf  ・・・ 設定ファイルの格納先
      │  └ config.php ・・・gmail/index.phpが読み込む
      │
      ├ class  ・・・ PHPクラスファイルの格納先
      │  ├ webserver_class ・・・Webサーバーへの登録処理をするクラス
      │  ├ mlserver_class ・・・MLサーバーへの登録処理をするクラス
      │  └ googleapi_class.php ・・・ GoogleApiの各種操作を行うクラス
      │
      ├ index.php ・・・ メインスクリプト
      │
      ├ batch_job.php ・・・ バッチ処理スクリプト
      │
      ├ .htaccess ・・・ IPv4 10.240.45/24 からのみアクセスできるよう制限
      └ .htdigest ・・・ ダイジェスト認証用



●ファイル詳細
      error-log_yyyymmdd.txt
         エラー発生時にのみ生成される
         yyyymmddは処理を行ったタイムスタンプ

      create-log_yyyymmdd.txt
         アカウント新規作成時に生成される
         yyyymmddは処理を行ったタイムスタンプ

      default.css
         index.htmlを整形するCSS

      index.html
         本アプリのメイン操作画面(表示のみ)

      config.php
         設定ファイル
         管理者アカウント情報、サーバー情報、およびログファイル、バッチ処理の設定が記述されている

      webserver_class.php
         WebサーバーへユーザーWeb領域を作成する処理が定義されているクラス
         WebサーバーへSSH接続を行い、ターミナルに対しコマンドを連続送信しアカウントの登録を行う(old_adduser_chroot2.plを叩いている)
         成否判定は、作成したユーザー領域にcdで移動できるかどうかでのみ行っている

      mlserver_class.php
         新規アカウントを規定MLへ登録する処理が定義されているクラス
         MLサーバーへSSH接続を行い、ターミナルに対しコマンドを連続送信しアカウントの登録を行う(regist_ml.shを叩いている)
         成否判定は、
         アナウンス、アラート、各職種MLのactivesとmembersに作成したユーザー名が存在しているかどうかを、職種ごとのパターンと比べることで行っている

      googleapi_class.php
         GoogleAPIを利用した各種アカウント操作が定義されているクラス
         定義されているメソッドの各機能は以下の通り
         アカウント情報取得、アカウント停止、アカウント再開、アカウント削除、パスワード変更要求、アカウント新規作成

      index.php
         本アプリのメインスクリプト
         処理開始ボタンクリックにより自身にPOSTされるアカウントリスト(テキストエリア)と処理内容(セレクトボックス)を受け取る
         どの一括操作が行われるかで分岐が行われ、アカウント作成以外であれば以下の通りの動作となる
         
         POSTされたアカウントリストは配列化され、その配列データをgoogleapiインスタンスに渡しインスタンス内の各メソッドにおいて処理を行う
         各メソッドでの処理中は例外処理が行われ、例外をキャッチした場合はそのエラー内容の一部とアカウント名の保持のみ行い、
         アカウントリストの最後に到達するまで処理は継続される
         もし例外が発生していた場合はインクルードされたindex.htmlにてエラー内容を描写し更にエラーログファイルを生成する

         アカウント作成の場合以下の通りの動作となる
         フォームに入力されたWebサーバー、MLサーバーのログインユーザー名およびパスワードから、サーバーへ接続が可能かチェックを行う
         接続に失敗すれば処理を終えエラーを表示する
         接続に成功した場合、googleapiインスタンスにユーザー情報を渡し、Gmailアカウントが存在しているかチェックを行う
         既に存在しているユーザーであった場合、以降の登録処理を全てスキップする
         登録されていないユーザーであれば、Gmailの新規登録を行い初回ログイン時のパスワード変更要求を行う
         ユーザーのログインパスワードの生成はアカウント新規作成時に同時に行っている
         また、パスワード変更要求の成否にかかわらず後の処理は継続する
         Gmailアカウントの作成に成功した場合、Web領域とML登録を行う
         共にSSHでサーバーへ接続を行い、既存の登録用スクリプトを叩きユーザーの登録を行っている
         (Webサーバー:old_adduser_chroot.pl MLサーバー:regist_ml.sh)
         以上の流れをアカウントリストの配列分繰り返し処理している

         処理終了後はlog/create/配下にログファイルを必ず生成し、
         各アカウント毎の作成/登録状況およびパスワード、エラー・警告表示等を確認できる

         おまけ機能として処理開始時から終了時までの時間を測定、表示している

      batch_job.php
         バッチ処理スクリプト
         アカウント新規作成機能によって生成されたログファイルを自動的に削除するスクリプト
         本スクリプトの起動はGolfのcrontabから行っている
         削除対象となるファイルは「生成日時から何日経過しているか」であり
         その経過日数の設定はconfig.iniに「$past_limit_date」として記述している

      .htaccess
         アクセス制限を行う
         全拒否した後、IPv4 10.240.45/24のアドレスからのみアクセスを許可している

      .htdigest
         アクセス制限を行う
         .htaccessでのダイジェスト認証用ファイル